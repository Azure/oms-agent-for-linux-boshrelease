#!/bin/bash

source /var/vcap/packages/omi/utils.sh

RUN_DIR=/var/vcap/sys/run/omsagent
LOG_DIR=/var/vcap/sys/log/omsagent

PID_FILE=$RUN_DIR/omsagent.pid
LOG_FILE=$LOG_DIR/omsagent.log

OMS_BIN=/var/vcap/packages/omsagent/opt/bin/omsagent
RUBY_BIN=/var/vcap/packages/omsagent/opt/ruby/bin/ruby


case $1 in

  start)

    pid_guard $PID_FILE omsagent

    # Swap the order of hostname, as syslog uses the first name behind 127.0.0.1 as hostname
    sed -i 's/127\.0\.0\.1 localhost \(.*\)/127\.0\.0\.1 \1 localhost/g' /etc/hosts

    # Write the onboard config
    workspace_id=<%= p('oms.workspace_id') %>
    workspace_key=<%= p('oms.workspace_key') %>

    cat <<EOF > /etc/omsagent-onboard.conf 
WORKSPACE_ID=$workspace_id
SHARED_KEY=$workspace_key
URL_TLD=opinsights.azure.com
EOF

    # Install packages
    which dpkg > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        dpkg -i -E /var/vcap/packages/scx/scx-bosh-cimprov-*.deb
        dpkg -i -E /var/vcap/packages/omsagent/omsagent-bosh-*.deb
        dpkg -i -E /var/vcap/packages/omsconfig/omsconfig-bosh-*.deb
    else
        rpm -i /var/vcap/packages/scx/scx-bosh-cimprov-*.rpm
        rpm -i /var/vcap/packages/omsagent/omsagent-bosh-*.rpm
        rpm -i /var/vcap/packages/omsconfig/omsconfig-bosh-*.rpm
    fi

    # Add omsagent user to vcap group for diretory access for dsc
    usermod -aG vcap omsagent

    # Create symlinks for dsc 
    mkdir -p /opt/microsoft
    ln -s /var/vcap/packages/omsagent/opt /opt/microsoft/omsagent
    ln -s /var/vcap/packages/omsconfig/opt /opt/microsoft/omsconfig
    mkdir -p /etc/opt/microsoft
    ln -s /var/vcap/packages/omsagent/etc /etc/opt/microsoft/omsagent
    mkdir -p /var/opt/microsoft
    ln -s /var/vcap/packages/omsagent/var /var/opt/microsoft/omsagent
    mkdir -p /etc/opt/omi/conf
    ln -s /var/vcap/packages/omi/etc/conf/omsconfig /etc/opt/omi/conf/omsconfig
    chown -h omsagent:omsagent /var/opt/microsoft/omsagent
    chown -h omsagent /etc/opt/omi/conf/omsconfig

    # Configure rsyslog if specfied
    rsyslog_selectors="<%= p('rsyslog.selector_list', []).join(' ') %>"
    rsyslog_port=<%= p('rsyslog.port', 25224) %>
    rsyslog_protocol=<%= p('rsyslog.protocol_type', 'udp') %>
    rsyslog_conf_file=/etc/rsyslog.d/95-omsagent.conf
    omsagent_conf_file=/var/vcap/packages/omsagent/etc/conf/omsagent.conf

    # Set the initial configuration
    cp /var/vcap/packages/omsagent/etc/sysconf/omsagent.conf $omsagent_conf_file
    cp /var/vcap/packages/omsagent/etc/sysconf/rsyslog.conf $rsyslog_conf_file

    # Set rsyslog protocol
    conf_str="@"
    if [ "${rsyslog_protocol,,}" = tcp ]; then
        conf_str="@@"
    fi
    sed -i "s/protocol_type \(udp\|tcp\)/protocol_type "${rsyslog_protocol,,}"/g" $omsagent_conf_file

    # Set rsyslog port
    sed -i "s/port [0-9]*/port ${rsyslog_port}/g" $omsagent_conf_file

    # Set rsyslog selectors
    conf_str="${conf_str}127.0.0.1:${rsyslog_port,,}"

    if [ -n "$rsyslog_selectors" ]; then
        echo "# Overwritten OMS Syslog collection" > $rsyslog_conf_file
        for conf in $rsyslog_selectors; do
           echo "$conf $(printf '\t\t')$conf_str" >> $rsyslog_conf_file
        done
    else
        sed -i "s/@*127\.0\.0\.1:[0-9]*/$conf_str/g" $rsyslog_conf_file
    fi

    service rsyslog restart

    # link the service_control file
    rm /var/vcap/packages/omsagent/opt/bin/service_control
    ln -s /var/vcap/jobs/omsagent/bin/omsagent-ctl /var/vcap/packages/omsagent/opt/bin/service_control

    $RUBY_BIN $OMS_BIN -d $PID_FILE -o $LOG_FILE --no-supervisor --user omsagent --group omiusers

    ;;

  stop)

    kill -sigkill `cat $PID_FILE`
    wait_until_process_stops $PID_FILE 5

    ;;

  restart)

    $0 stop
    pid_guard $PID_FILE omsagent
    $RUBY_BIN $OMS_BIN -d $PID_FILE -o $LOG_FILE --no-supervisor --user omsagent --group omiusers

    ;;

  find-systemd-dir)

    find_systemd_dir

    ;;

  *)

    echo "Usage: $0 {start|stop|restart|find-systemd-dir}"

    ;;

esac


